---
title: "[ACP考试] - 阿里云SLB"
catalog: true
date: 2020-09-12 15:20:24
subtitle: ""
header-img: "/img/default.png"
tags:
- 阿里云
catagories:
---

#### SLB的概念

##### 为什么需要负载均衡

随着业务流量的增加，单机服务的部署模式的单点故障，流量瓶颈等问题愈发明显，因此我们希望能够以多台服务器集群的方式来对外提供服务。可以通过提高服务器数量的方式来提高性能和稳定型。负载均衡的出现提供了一种有效的方法扩展网络设备和服务器的带宽，增加吞吐量，加强网络数据处理能力、提高网络的灵活性和可用性。

##### SLB与传统负载均衡相比

||SLB负载均衡|传统硬件负载均衡器|
|--|--|--|
|扩展性|支持删除和添加后端服务器，实现无缝伸缩。|当目前硬件设备达到相应的瓶颈时，需要重新购买更高性能硬件设备重新安装，业务中断，步骤繁杂。|
|安全|免费提供四层DDos攻击防护|需要购买安全防护模块，部署困难，成本较高。|
|成本|无需购买硬件资源，终身免运维，提供按流量和按带宽两种付费方式，可根据业务灵活选取，共享型私网实例费用全免。|需要购买硬件设备，聘请专业的运维人员，而且硬件资源容易限制浪费。|

##### 阿里云SLB的功能

+ 同城容灾：可用区级的高可用，故障自动切换。
+ 流量分发：对多台云服务器自动进行流量分发，拓展系统服务能力。
+ 简明易用：多种付费类型，轻松管理。
+ 超强性能：推出性能保障型实例，并提供超高性能规格的实例。

##### SLB应用场景

+ 高访问量的业务
+ 拓展应用程序
+ 消除单点故障
+ 同城容灾

##### SLB的组成

+ LoadBalancer
+ Listener
+ BackendServer

##### SLB的术语

+ 负载均衡，Server Load Balancer
+ 地域，Region
+ 可用区，Zone
+ 负载均衡实例，LoadBalancer
+ 负载均衡监听器，Listener
+ 后端服务器，BackendServer
+ 地址，Address

##### 协议支持

负载均衡基础架构是采用集群部署，提供四层(TCP和UDP)，七层(HTTP和HTTPS)两种方式来实现会话同步。

+ 四层采用开源LVS(Linux Virtual Server) + keepalived。
+ 七层采用Tengine实现负载均衡。

##### 转发方式的工作原理

+ (加权)轮询模式：会将外部和内部的访问请求依序分发给后端ECS进行处理。
+ 最小连接数模式：访问请求分发给当前连接数最小的一台后端ECS进行处理。

##### 会话保持及权重设置的工作原理

会话保持：  
四层TCP：同一IP地址的请求持续发往同一台服务器。
七层HTTP：相同cookie同的请求发往同一台服务器。

权重设置：请求按权重大小依次分发。

##### SLB如何和云产品结合

+ SLB不能跨地域，可以跨可用区。需要跨Region时可以使用智能DNS来实现。
+ ECS：挂载同Region下的ECS，实现集群服务。
+ 云盾：提供DDos防护。
+ 弹性伸缩服务：结合弹性伸缩服务可以做到弹性扩容。
+ 对象存储OSS、数据库RDS：用户通过ECS上的应用访问OSS、RDS等应用。同时可以直接在ECS上部署DB等应用，通过SLB做负载均衡。

##### 监听

创建负载均衡实例后，需要为实例配置监听。负载均衡实例监听负责检查连接请求，让后根据算法定义的转发策略将请求流量分发给后端服务器。
+ TCP：面向连接协议，适用于注重可靠性，对数据准确性要求高，速度可以相对较慢的场景。
+ UDP：面向非连接的协议，可靠性相对较低，适用于视频聊天，金融实时数据推送。
+ HTTP：应用层协议，基于Cookie实现会话保持，适用于对数据内容进行识别的应用，如web应用。
+ HTTPS：加密传输数据，可阻止未经授权的访问。适用于注重安全性的应用。

##### 监听转发

HTTPS是加密数据传输协议，安全性高。负载均衡支持将HTTP访问重定向至HTTPS，方便进行全站HTTPS部署。负载均衡已经在全部地域实现了HTTP重定向功能。

##### 后端服务器

注意：
+ 负载均衡不支持跨Region部署。
+ 负载均衡不限制后端服务器操作系统。
+ 一个实例最多50个监听。
+ 可以指定后端ECS实例转发权重。
+ 会话保持可能会导致服务器访问压力不平衡

分类：
+ 默认服务器组
+ 主备服务器组
+ 虚拟服务器组

##### 健康检查

负载均衡通过健康检查来判断后端服务器的业务可用性。如果检测某台服务挂了，会将流量分发给其他服务器，当服务器恢复后，流量会重新分发回来。检查是有Heart beating方式测试。

##### 访问控制

访问控制可以通过设置白名单和黑名单来配置。

#### SLB的配置

##### 如何选购SLB

1. 规划实例地域
2. 选择实例的网络类型(选择合适的计费方式)
3. 选择实例规格(考虑连接数和吞吐量)
4. 选择协议类型(四层或七层)
5. 准备后端服务器

##### SLB的计费

1. 按量付费(按流量计费或按带宽付费)
2. 预付费(包年包月)

费用分为计费项实例费，流量费，带宽费，规格费。所有性能保障型模式都要收取规格费，只有公网类型才会收取计费项实力费。

##### SLB负载均衡相关限制

+ 一个账号可创建SLB实力数量是60；
+ 一个ECS实例可关联的SLB的次数是50；
+ 一个SLB实例可添加的后端服务器数量是200；
+ 一个SLB实例可添加的监听数量是50；
+ 一个HTTP/HTTPS监听可添加的域名和URL转发规则数量40；
+ 一个HTTPS监听可创建的扩展域名数量3；
+ 一个AccessKey的API访问频率限制是5000次/天；
+ SLB实例监听可选择的前端/后端端口范围 1 - 65535；

#### 弹性伸缩(Auto Scaling)

##### AS的概念

使用弹性伸缩可以根据业务需求和策略设置伸缩规则，在业务需求增长时自动为您增加ECS实例以保证服务端计算能力，在业务需求下降时自动减少ECS实例数量以节省成本。例如：
+ 平均vCPU > 80%时，添加一台实例。
+ 平均vCPU < 30%时，减少一台实例。

##### 使用场景

+ 弹性扩张
+ 弹性收缩
+ 弹性自愈

##### 弹性伸缩模式

+ 定时模式：自定义自动伸缩的时间和频率。
+ 动态模式：基于云监控指标，自动增加或减少ECS实例。
+ 固定数量模式：设置最小实例数量，即健康运行的ECS实例最小数量，以保证可用性。
+ 自定义模式：通过API调用自由监控系统，可以执行手动伸缩。
+ 健康模式：ECS非Running状态，弹性伸缩将自动移除或释放不健康的ECS实例。
+ 多模式并存：以上各模式的组合。

##### 弹性伸缩的组件

+ 伸缩组：弹性伸缩的ECS实例的组合。
+ 伸缩配置：定义了弹性ECS实例的配置信息。
+ 伸缩规则：定义了具体扩展或收缩的规则。
+ 伸缩活动：伸缩规则成功触发后就会产生一条伸缩活动。用来描述ECS实例的变化情况。
+ 伸缩触发任务：用于触发规则的任务，如定时任务，云监控的报警任务。
+ 冷区时间：在同一伸缩组内，一个伸缩活动执行完成后的一段锁定时间。在这段时间内，该伸缩组不执行其他的伸缩活动。

##### 生命周期挂钩

在伸缩组进行伸缩活动时，正在加入或正在移出的伸缩组实例将被挂起并置于等待状态。生命周期挂钩仅在自动创建或移出ECS实例时生效，手动添加或移出ECS实例时不受其影响。在保持等待状态的时间内会有以下特征：
+ 伸缩组不再运行其他活动
+ 保留指定时长的操作时间，可以在期间执行自定义操作
+ 可以删除生命周期挂钩来恢复执行伸缩活动
+ 可以调用API来结束生命周期活动或删除生命周期挂钩

##### 弹性伸缩优势

+ 随需应变
+ 自动化
+ 智能
+ 伸缩模式丰富

##### 弹性伸缩的配置步骤

创建弹性伸缩组 -> 创建伸缩配置 -> 启用伸缩组 -> 创建伸缩规则 -> 创建定时任务 -> 创建报警任务

##### 弹性伸缩工作流程

1. 监控健康情况/监控性能
2. 执行伸缩活动
3. 增加ECS实例
    1. 增加多少ECS实例？
    2. 创建什么类型ECS实例？
    3. 创建伸缩活动
4. 创建ECS实例
5. 添加ECS实例到伸缩组中，并配置负载均衡
6. 冷却伸缩组

##### 弹性伸缩的报警任务

弹性伸缩报警任务是弹性伸缩和云监控服务CMS深度合作，提供的一种动态管理伸缩组的方式，类似于弹性伸缩定时任务，弹性伸缩报警任务通过触发指定的弹性伸缩规则来执行伸缩活动，达到伸缩组内实例个数的目的。

##### 报警任务创建流程

登录弹性伸缩控制台 -> 单击自动触发任务管理 > 报警任务 -> 单击创建报警任务 -> 配置各项信息 -> 完成

##### 弹性伸缩的计费

可以免费开通弹性伸缩服务，但是弹性伸缩创建的实例是要收费的。自动创建ECS付费的方式有：
+ 按量付费
+ 抢占式实例

##### 弹性伸缩的使用限制

+ 伸缩组内部署的ECS实例的应用必须无状态并且可横向扩展。
+ 伸缩组内的ECS实例可能会被自动释放，不适合保存应用状态信息和相关数据等信息。
+ 弹性伸缩无法自动将ECS实例添加到开放缓存Memcache实力访问白名单，需要自行添加。
+ 弹性伸缩无法纵向扩展。
+ 能创建伸缩组、伸缩配置、伸缩规则等一定限制。