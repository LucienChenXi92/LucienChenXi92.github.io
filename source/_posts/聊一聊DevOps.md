---
title: "聊一聊DevOps"
catalog: true
date: 2020-06-25 10:51:24
subtitle: "分享一些DevOps的理解和实践"
header-img: "/img/default.png"
tags:
- Blog
- DevOps
catagories:
---

终于迎来了三天小长假，一个多月了没更新博客了，趁这个机会把最近积累的东西沉淀一下。前几天听到同事闲聊有提到DevOps，所以不妨今天就聊聊我对DevOps的理解和过去工作中DevOps实践吧。

### 敏捷已成为主流开发模式
随着现代互联网市场的变化越来越快，这对传统的互联网开发模式提出了极大的挑战，越来越多公司从瀑布式开发转向了敏捷式开发。举个简单的例子，如果我们想要做一个短视频平台。按照过去瀑布式开发需要先花个月去设计产品，明确需求，最后产出一本本厚厚的需求文档交给开发团队去开发。按照这个节奏，可能我们的产品还没上线，市场早已被竞争对手瓜分完了。即便能够顺利上线，由于产品获得用户反馈的周期过长，无法及时地进行调整，终将会被市场所抛弃。所以现在互联网开发的套路都是以最快速度让产品先上线，获得一部分受众，根据用户的反馈不断优化功能，产品变得更好自然能赢得更好的口碑，吸引更多的用户。所以成功的产品往往是同用户一起成长起来。
说了这么多，其实是要大家明白敏捷已成为主流的开发模式。表面上看是要拥抱变化并能够对产品进行快速调整，而背后其实是对公司内部产品，开发，测试，运维各部门的沟通协作提出更高的要求。

### 什么是DevOps
DevOps在维基百科上的解释是Develop(开发)和Operations(运营)这两个单词的组合，是一种重视开发人员和IT运维人员之间沟通合作的文化，运动或惯例。透过自动化软件交付和架构变更的流程，来使得构建，测试，发布软件更加敏捷，频繁和可靠。很多公司内部，开发部门和运维部门都是分开设立的，而且两个部门的目标也是不同的。开发人员追求的是交付效率，希望能够将自己完成的功能随时发布上产品环境。而运维人员追求的是稳定性，频繁的发布不但增加了运维人员的工作负担，而且也大大增加了线上出问题的概率。DevOps的核心思想就是将两个部门合并，更确切的说是将两种角色合并。DevOps工程师既要负责产品功能的开发，又要负责产品的发布，部署，监控等任务，这样就可以打破开发和运维两种角色的对立，进而能够在交付频率和线上稳定性上找到一种平衡。虽然这个想法是好的，但既要开发功能，又要负责运营维护，这样的改变势必会增加工作的复杂度和强度的，所以想要实现DevOps就一定需要自动化工具来提升团队的生产开发效率。

![/img/agile_devops.png](/img/agile_devops.png)

上面这幅图是我对敏捷，DevOps两者关系的理解。首先敏捷开发(Agile)其实是一种思想并提供一系列的方法论，大家感兴趣的话可以看一下[敏捷宣言原则](https://agilemanifesto.org/iso/zhchs/principles.html)，里面可以了解到敏捷开发的一些基本价值观。而DevOps是基于敏捷方法论下的一种最佳实践，通过开发和运维的角色合并，利用自动化的工具来实现更好的协作与沟通，进而实现更加流畅和高效的交付。

### DevOps是如何运作的
![/img/devops_ring.png](/img/devops_ring.png)

上面这幅图片是在google上面找的，相信很多同学都见过。这个图很清晰的展现了DevOps的运作流程。Plan, Code, Build, Test, Release, Deploy, Operation, Monitor完成一个迭代。但实际上，Operation和Monitor两个环节其实24/7持续进行的，并不是明确的可完成的事件。整个循环的背后有很多自动化工具来支撑。例如Plan可能会依赖Jira，Confluence，Trello等敏捷开发管理工具。Code可能会需要Git或SVN等版本控制工具，Build，Release，Devploy需要Jenkins来快速打包部署。Monitor则依赖各种日志工具和Dashboard，像ELK，Splunk，Grafana等等。Operation则需要依赖各种云Console platform。跳出DevOps循环，贯穿始终的沟通协调还需要Slack，Skype这样的即时通讯工具。接下来会讲讲自己过往工作中的DevOps体验。

### DevOps的亲身体验
由于还没有系统的梳理过，所以我就直接我能想到的`团队，沟通，开发，运维，监控`等方面来分别讲一讲我的一些DevOps体验，重点讲讲自动化工具是如何提高日常的生产开发效率的。

#### 团队
由于是微服务架构，各团队专注于自己的领域，团队规模也不会太大，一般都会在7个人左右。即便因为组织架构等因素某个团队可能会比较大，但这么多人一般也会专注于不同的几个产品和项目上。为了降低沟通成本，平时开会也都会分开进行。一般团队中会有一个TPM(扮演Scrum中的PO角色)，还有一个Tech Leader，其他人可以统称为Dev了。TPM负责需求的挖掘与收集，提供Story，澄清需求等等。Tech leader自然是负责技术选型，为团队提供技术支持等等。Dev则负责需求的实现，测试，发布，部署，监控，运维等所有环节。Dev要为自己所take的需求负责，既要保证如期交付，又要保证功能稳定性，至于如何实现则拥有非常高的自由度。每个人在团队中有着明确的职责和定位，每个Sprint团队又会有着明确的目标，大家会朝着这一目标共同努力，紧密合作，非常有那种创业小公司的干劲。

#### 沟通
首先沟通氛围上，可能是欧美企业文化的原因，整个团队内部一般都是水平沟通，没有太明显上下级的感觉，所以整个办公室的沟通氛围都是挺轻松自在的，有问题或是有困难可以放心大胆的说出来，不用有什么心里负担。其次沟通渠道上，一般同一团队成员都会坐在同一办公室，面对面沟通效率最高。如果没办法坐在一起，同时区的就在Slack上call一下，不是太复杂的问题几分钟也都能讲清楚。跨时区的话可能就麻烦一些，需要发邮件或是Slack上留言一下。在开发中过程中，对需求有疑问可以随时找TPM来澄清，需要技术支持可以随时联系Tech leader或其他同事。在沟通如此便利的条件下，团队的协作的效率很高，而且培养出一种主动沟通和主动解决问题的企业文化。沟通绝不应该成为Blocker。

#### 交付
团队采用Scrum模式进行开发，两个星期为一个sprint，首先值得说的是Story完成的定义(Definition of Done)，一般认为一个Story的功能得以实现，经过自己在test环境进行测试，Release到Prod环境进行测试，最终得到TPM的验收才算完成。这么一看整个流程还是挺长的，但实际上在公司的CI/CD平台的帮助下，繁琐的Build，Release，Deploy都变得非常便利。从编译到Release Prod环境一般也就花费10分钟的样子。如果没有这些自动化工具的帮助，日常在部署上的时间开销会变得不敢想象。

#### 运维
在DevOps的模式下，每个Dev都或多或少要掌握一些运维的知识。由于整个公司的产品都部署在AWS cloud上，这使得公司可以开发一套平台通过AWS的提供的API自动化地申请和配置资源。例如，我的团队需要创建一个新的微服务项目，我只需要在平台上建立一个申请，输入项目名字和一些必要信息，平台会帮忙自动在Github中创建Repo，并在AWS上为其申请对应的ECS，ELB，CNAME等资源。因此，各个开发团队不再需要花时间在这些机械繁琐的事情上。另外，例如Elasticsearch，Redis，Dynamic DB这些资源也可以通过AWS console很方便的去进行资源申请或配置调整，简单方便。当然，有时间的时候还是要对K8s，Docker，AWS cloud这些技术深入学习一下。

#### 监控
产品线上稳定性的监控是DevOps工作中非常重要的部分，公司一般都会有MTTD(mean time to detect)的指标，这可是要算进团队KPI的。一般开发团队自己会通过一些日志工具或Dashboard上面去设置一些告警，比如当Http 5XX数量激增的时候要给团队值班人员打电话处理异常。过去常常会半夜两点收到公司的pagerduty oncall说我们的某某项目挂掉了，或是在过去30分钟之内没能消费到数据。发生这种异常的时候就要立即拿出电脑，连上VPN，然后trouble shooting。在做过线上监控和运维之后，你会发现自己思考的方式会有很大的变化。当你开发某一个功能时你不再只关注于实现，而是要考虑几种实现方式之下，哪种方式更健壮。我的日志是否足够清晰到让我定位到问题。我建立的Dashboard是否能帮我捕捉到所有的异常。甚至是当我的产品挂了，我有没有Plan B。这些问题的思考会让Dev成长很多。

### 总结
总结一下DevOps的优点：
1. DevOps开发团队更高效，灵活。砍去了繁琐重复的劳动，能将更多的精力花费在核心业务模块上。
2. 从接受需求到产品上线，Dev贯穿全过程，这有利于培养起Dev的Ownership。
3. Dev在开发的过程中就会兼顾考虑线上可能出现的问题及其解决方案，代码会更健壮。
4. DevOps开发团队技术栈囊括开发和运维，视野和思考高度更高一些，不要只做code writer而要做trouble solver。